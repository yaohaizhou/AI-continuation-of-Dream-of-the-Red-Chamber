"""
æµ‹è¯•ä¸Šä¸‹æ–‡å‹ç¼©å™¨
Test Context Compressor - æ¼”ç¤ºé•¿æ–‡æœ¬å‹ç¼©åŠŸèƒ½
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), 'src'))

from long_text_management.context_compressor import ContextCompressor, CompressedContext
import json

def test_context_compressor():
    """æµ‹è¯•ä¸Šä¸‹æ–‡å‹ç¼©å™¨çš„åŸºæœ¬åŠŸèƒ½"""
    
    # æ¨¡æ‹Ÿå‡ ä¸ªç« èŠ‚çš„æ–‡æœ¬å†…å®¹
    sample_chapters = [
        """ç¬¬ä¸ƒåå…«å› è€å­¦å£«é—²å¾å§½å©³è¯ ç—´å…¬å­æœæ’°èŠ™è“‰è¯”
        
        è¯è¯´è´¾æ”¿å›å®¶ï¼Œè§è¿‡è´¾æ¯ï¼Œå³åˆ°æˆ¿å†…ï¼Œè§è¿‡ç‹å¤«äººï¼Œä¾¿å«å®ç‰ã€‚å®ç‰å¿™èµ°æ¥ï¼Œ
        è´¾æ”¿é“ï¼š"ä½ å‰æ—¥ä½œçš„é‚£å¤é£å¦‚ä½•äº†ï¼Ÿ"å®ç‰é“ï¼š"å·²ç»ä½œå®Œäº†ã€‚"è´¾æ”¿é“ï¼š"æ‹¿æ¥æˆ‘çœ‹ã€‚"
        å®ç‰ç­”åº”ä¸€å£°ï¼Œå³å»å–äº†æ¥ã€‚è´¾æ”¿çœ‹äº†ä¸€å›ï¼Œç‚¹å¤´é“ï¼š"è¿™ä¸ªå¯ä»¥ã€‚ä½ è¿‘æ¥ä¸¾ä¸šå¦‚ä½•äº†ï¼Ÿ"
        å®ç‰é“ï¼š"æ­£è¦ç¦€çˆ¶äº²ï¼Œè¿‘æ¥ä¸¾ä¸šç¨æœ‰è¿›ç›Šã€‚"è´¾æ”¿é“ï¼š"é‚£æ˜¯å†å¥½æ²¡æœ‰çš„äº†ã€‚"
        """,
        
        """ç¬¬ä¸ƒåä¹å› è–›æ–‡é¾™æ‚”å¨¶æ²³ä¸œç‹® è´¾è¿æ˜¥è¯¯å«ä¸­å±±ç‹¼
        
        è¯è¯´è´¾æ”¿æ­£åœ¨æˆ¿å†…ï¼Œå¿½è§æ—ä¹‹å­è¿›æ¥è¯´é“ï¼š"å¤–é¢æœ‰èƒ¡è€çˆ·å‰æ¥æ‹œä¼šã€‚"
        è´¾æ”¿å¬äº†ï¼Œå³ä¾¿å‡ºå»ã€‚è¿™èƒ¡è€çˆ·åŸæ˜¯è´¾æ”¿çš„åŒå¹´ï¼Œæ­¤æ—¶æ­£åœ¨å·¥éƒ¨ã€‚
        è§é¢ä¹‹åï¼Œèƒ¡è€çˆ·ç¬‘é“ï¼š"ä»Šæ—¥ç‰¹æ¥æ‹œè®¿ï¼Œæœ‰ä¸€ä»¶äº‹ç›¸æ±‚ã€‚"
        è´¾æ”¿é“ï¼š"æœ‰ä½•è§æ•™ï¼Ÿ"èƒ¡è€çˆ·é“ï¼š"å°å„¿é¡½åŠ£ï¼Œæ¬²é€å…¥è´µåºœä¹¦æˆ¿ï¼Œ
        è·Ÿç€å®å“¥å„¿ä¸€å¤„è¯»ä¹¦ï¼Œä¸çŸ¥å¯å¦ï¼Ÿ"è´¾æ”¿ç¬‘é“ï¼š"è¿™æœ‰ä½•ä¸å¯ï¼Œåªæå®¶æ…å¾®è–„ï¼Œ
        ä¸èƒ½å¼€å¯¼ã€‚"ä¸¤äººè¯´ç¬‘ä¸€å›ï¼Œèƒ¡è€çˆ·å‘Šè¾è€Œå»ã€‚
        """,
        
        """ç¬¬å…«åå› ç¾é¦™è±å±ˆå—è´ªå¤«æ£’ ç‹é“å£«èƒ¡è¯Œå¦’å¦‡æ–¹
        
        è¯è¯´ç‹å¤«äººè§è´¾æ”¿æ°”è‰²æ¯”å…ˆå¥½äº›ï¼Œå¿ƒå†…ç€å®æ¬¢å–œã€‚åˆè§å®ç‰ä¸¾ä¸šæœ‰äº†è¿›ç›Šï¼Œ
        æ›´åŠ æ”¾å¿ƒã€‚è¿™æ—¥æ­£å’Œè´¾æ¯è¯´è¯ï¼Œå¿½è§å‡¤å§èµ°æ¥ï¼Œæ»¡é¢æ„å®¹ã€‚
        è´¾æ¯è§äº†ï¼Œä¾¿é—®é“ï¼š"ä½ è¿™æ˜¯æ€ä¹ˆäº†ï¼Ÿ"å‡¤å§å‹‰å¼ºç¬‘é“ï¼š"æ²¡æœ‰ä»€ä¹ˆï¼Œ
        åªæ˜¯å®¶åŠ¡äº‹ç¹çï¼Œæœ‰äº›ä¹å›°ã€‚"ç‹å¤«äººé“ï¼š"ä½ èº«å­è¦ç´§ï¼Œ
        åˆ«å¤ªåŠ³ç´¯äº†ã€‚"å‡¤å§ç‚¹å¤´é“ï¼š"åª³å¦‡çŸ¥é“äº†ã€‚"
        """
    ]
    
    print("=== æµ‹è¯•ä¸Šä¸‹æ–‡å‹ç¼©å™¨ ===\n")
    
    # åˆ›å»ºå‹ç¼©å™¨å®ä¾‹
    compressor = ContextCompressor(max_context_length=1000)
    
    # å‹ç¼©ç« èŠ‚
    print("1. å¼€å§‹å‹ç¼©ç« èŠ‚...")
    compressed_context = compressor.compress_chapters(sample_chapters, target_chapter=81)
    
    print(f"   åŸå§‹æ–‡æœ¬é•¿åº¦: {compressed_context.original_word_count} å­—ç¬¦")
    print(f"   å‹ç¼©åé•¿åº¦: {compressed_context.compressed_word_count} å­—ç¬¦")
    print(f"   å‹ç¼©æ¯”ä¾‹: {compressed_context.compression_ratio:.2%}\n")
    
    # æ˜¾ç¤ºå‹ç¼©ç»“æœ
    print("2. å‹ç¼©ç»“æœæ‘˜è¦:")
    for i, summary in enumerate(compressed_context.previous_chapters_summary):
        print(f"   ç¬¬{summary.chapter_num}å›: {summary.title}")
        print(f"   - å…³é”®äº‹ä»¶: {summary.key_events}")
        print(f"   - äººç‰©çŠ¶æ€: {summary.character_states}")
        print(f"   - æƒ…æ„ŸåŸºè°ƒ: {summary.emotional_tone}")
        print()
    
    # ç”Ÿæˆç»­å†™æç¤ºè¯
    print("3. ç”Ÿæˆç»­å†™æç¤ºè¯:")
    current_context = "å®ç‰æ­£åœ¨å¤§è§‚å›­ä¸­é—²æ­¥ï¼Œå¿½è§é»›ç‰ä»æ½‡æ¹˜é¦†èµ°å‡º..."
    prompt = compressor.generate_context_prompt(compressed_context, current_context)
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print()
    
    # ä¿å­˜å‹ç¼©ç»“æœ
    print("4. ä¿å­˜å‹ç¼©ç»“æœ...")
    output_file = "data/compressed_context_example.json"
    compressor.save_compressed_context(compressed_context, output_file)
    print(f"   å·²ä¿å­˜åˆ°: {output_file}")
    
    return compressed_context

def analyze_compression_effectiveness():
    """åˆ†æå‹ç¼©æ•ˆæœ"""
    print("\n=== å‹ç¼©æ•ˆæœåˆ†æ ===")
    
    # è®¡ç®—ä¸åŒæ–‡æœ¬é•¿åº¦çš„å‹ç¼©æ•ˆæœ
    test_cases = [
        ("çŸ­æ–‡æœ¬", "å®ç‰è¯´é“ï¼š'ä»Šæ—¥å¤©æ°”ç”šå¥½ã€‚'é»›ç‰å¬äº†ï¼Œå¾®å¾®ä¸€ç¬‘ã€‚"),
        ("ä¸­ç­‰æ–‡æœ¬", "å®ç‰æ¥åˆ°æ½‡æ¹˜é¦†ï¼Œè§é»›ç‰æ­£åœ¨è¯»ä¹¦ã€‚é»›ç‰è§ä»–æ¥äº†ï¼Œæ”¾ä¸‹ä¹¦æœ¬ï¼Œç¬‘é“ï¼š'ä½ ä»Šæ—¥æ€ä¹ˆæœ‰ç©ºåˆ°è¿™é‡Œæ¥ï¼Ÿ'å®ç‰é“ï¼š'é—²æ¥æ— äº‹ï¼Œæƒ³èµ·å¦¹å¦¹ï¼Œä¾¿è¿‡æ¥çœ‹çœ‹ã€‚'ä¸¤äººè¯´ç¬‘ä¸€å›ï¼Œé¢‡ä¸ºæ¬¢æ„‰ã€‚"),
        ("é•¿æ–‡æœ¬", """
        è¯è¯´è´¾æ”¿å›åˆ°å®¶ä¸­ï¼Œå¿ƒä¸­é¢‡ä¸ºå¿§è™‘ã€‚è‡ªä»ä¸Šæ¬¡åœ¨æœä¸­å¬åˆ°é£å£°ï¼Œä¾¿çŸ¥å®¶ä¸­ææœ‰å˜æ•…ã€‚
        è¿™æ—¥æ­£åœ¨ä¹¦æˆ¿ä¸­æ€è™‘ï¼Œå¿½è§å®ç‰èµ°æ¥ã€‚è´¾æ”¿è§äº†ï¼Œé—®é“ï¼š"ä½ æ¥åšä»€ä¹ˆï¼Ÿ"
        å®ç‰é“ï¼š"å„¿å­æƒ³è¯·æ•™çˆ¶äº²ä¸€äº‹ã€‚"è´¾æ”¿é“ï¼š"ä»€ä¹ˆäº‹ï¼Ÿ"
        å®ç‰é“ï¼š"è¿‘æ—¥è¯»ä¹¦ï¼Œæœ‰äº›ä¸è§£ä¹‹å¤„ï¼Œæƒ³è¯·çˆ¶äº²æŒ‡ç‚¹ã€‚"
        è´¾æ”¿å¬äº†ï¼Œå¿ƒä¸­ç¨å®‰ï¼Œé“ï¼š"è¿™æ ·æœ€å¥½ï¼Œä½ ä¸”è¯´æ¥å¬å¬ã€‚"
        å®ç‰äºæ˜¯å°†æ‰€ç–‘ä¹‹å¤„ä¸€ä¸€è¯´äº†ã€‚è´¾æ”¿å¬å®Œï¼Œç‚¹å¤´é“ï¼š"ä½ è¿™äº›é—®é¢˜é—®å¾—å¾ˆå¥½ï¼Œ
        è¯´æ˜è¯»ä¹¦ç”¨å¿ƒäº†ã€‚"çˆ¶å­äºŒäººå°±è¿™æ ·è°ˆè®ºèµ·æ¥ï¼Œç›´åˆ°æ—¥æš®æ‰ç½¢ã€‚
        """)
    ]
    
    compressor = ContextCompressor()
    
    for name, text in test_cases:
        print(f"\n{name} (åŸé•¿åº¦: {len(text)} å­—ç¬¦):")
        
        # åˆ›å»ºå•ç« æ‘˜è¦
        summary = compressor._create_chapter_summary(text, 1)
        
        # ä¼°ç®—å‹ç¼©åå¤§å°
        compressed_size = compressor._estimate_compressed_size([summary])
        compression_ratio = compressed_size / len(text) if len(text) > 0 else 0
        
        print(f"  å‹ç¼©å: {compressed_size} å­—ç¬¦")
        print(f"  å‹ç¼©æ¯”: {compression_ratio:.2%}")
        print(f"  å…³é”®äº‹ä»¶æ•°: {len(summary.key_events)}")
        print(f"  æ£€æµ‹åˆ°äººç‰©æ•°: {len(summary.character_states)}")

if __name__ == "__main__":
    try:
        # æµ‹è¯•åŸºæœ¬åŠŸèƒ½
        compressed_context = test_context_compressor()
        
        # åˆ†æå‹ç¼©æ•ˆæœ
        analyze_compression_effectiveness()
        
        print("\nâœ… æµ‹è¯•å®Œæˆï¼ä¸Šä¸‹æ–‡å‹ç¼©å™¨è¿è¡Œæ­£å¸¸ã€‚")
        print("\nğŸ“ ä¸‹ä¸€æ­¥å»ºè®®:")
        print("1. é›†æˆLLMæ¥æå‡æ‘˜è¦è´¨é‡")
        print("2. ä¼˜åŒ–å…³é”®ä¿¡æ¯æå–ç®—æ³•")
        print("3. æ·»åŠ æ›´å¤šçš„å‹ç¼©ç­–ç•¥")
        print("4. ä¸ç°æœ‰çš„çŸ¥è¯†å¢å¼ºç³»ç»Ÿé›†æˆ")
        
    except Exception as e:
        print(f"âŒ æµ‹è¯•å¤±è´¥: {e}")
        import traceback
        traceback.print_exc() 